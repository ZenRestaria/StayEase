@startuml
' Title
title StayEase ERD (expanded) - Users, Listings, Services, Bookings, Chat, Reviews, Admin, Payments

' Entities
entity "user" as user {
  * id : BIGINT <<PK>>
  * public_id : UUID
  * email : VARCHAR(255) <<UNIQUE>>
  * first_name : VARCHAR(100)
  * last_name : VARCHAR(100)
  * image_url : VARCHAR(500)
  * password_hash : VARCHAR(255)   -- optional (if local auth)
  * verified : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "authority" as authority {
  * name : VARCHAR(50) <<PK>>   -- e.g. ROLE_TENANT, ROLE_LANDLORD, ROLE_ADMIN
  --
  * description : VARCHAR(255)
}

entity "user_authority" as user_authority {
  * user_id : BIGINT <<FK user.id>>
  * authority_name : VARCHAR(50) <<FK authority.name>>
  * assigned_at : TIMESTAMP
  * PRIMARY_KEY(user_id, authority_name)
}

entity "listing" as listing {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * landlord_public_id : UUID   -- FK to user.public_id (denormalized)
  * title : VARCHAR(255)
  * description : TEXT
  * location : VARCHAR(255)
  * price : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * guests : INT
  * bedrooms : INT
  * beds : INT
  * bathrooms : INT
  * category : VARCHAR(100)
  * rules : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "listing_image" as listing_image {
  * id : BIGINT <<PK>>
  * listing_id : BIGINT <<FK listing.id>>
  * url : VARCHAR(1000)
  * caption : VARCHAR(255)
  * sort_order : INT
  * created_at : TIMESTAMP
}

entity "service" as service {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * provider_public_id : UUID   -- FK to user.public_id
  * title : VARCHAR(255)
  * description : TEXT
  * price : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * service_type : VARCHAR(100)  -- e.g. experience, transport
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "service_image" as service_image {
  * id : BIGINT <<PK>>
  * service_id : BIGINT <<FK service.id>>
  * url : VARCHAR(1000)
}

entity "booking" as booking {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * listing_id : BIGINT <<FK listing.id>>   -- nullable if service-only booking
  * tenant_public_id : UUID   -- FK to user.public_id
  * status : VARCHAR(50)   -- PENDING, CONFIRMED, CANCELLED, COMPLETED
  * start_date : DATE
  * end_date : DATE
  * nb_of_travelers : INT
  * total_price : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "service_booking" as service_booking {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * service_id : BIGINT <<FK service.id>>
  * customer_public_id : UUID   -- FK user.public_id
  * booking_date : TIMESTAMP    -- scheduled date/time for the service
  * status : VARCHAR(50)
  * quantity : INT
  * total_price : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * created_at : TIMESTAMP
}

entity "booking_addon" as booking_addon {
  * id : BIGINT <<PK>>
  * booking_id : BIGINT <<FK booking.id>>
  * title : VARCHAR(255)
  * price : DECIMAL(12,2)
  * quantity : INT
}

entity "payment" as payment {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * related_booking_id : BIGINT <<FK booking.id>>   -- nullable
  * related_service_booking_id : BIGINT <<FK service_booking.id>> -- nullable
  * payer_public_id : UUID   -- FK user.public_id
  * payee_public_id : UUID   -- FK user.public_id (platform or host)
  * amount : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * method : VARCHAR(50)   -- e.g. stripe, paypal
  * status : VARCHAR(50)   -- pending, succeeded, refunded
  * transaction_reference : VARCHAR(255)
  * created_at : TIMESTAMP
}

entity "payout" as payout {
  * id : BIGINT <<PK>>
  * host_public_id : UUID   -- FK user.public_id
  * amount : DECIMAL(12,2)
  * currency : VARCHAR(10)
  * method : VARCHAR(50)
  * status : VARCHAR(50)
  * created_at : TIMESTAMP
}

entity "review" as review {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * author_public_id : UUID   -- FK user.public_id
  * target_listing_id : BIGINT <<FK listing.id>>    -- nullable
  * target_service_id : BIGINT <<FK service.id>>    -- nullable
  * rating : INT   -- 1..5
  * title : VARCHAR(255)
  * body : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "conversation" as conversation {
  * id : BIGINT <<PK>>
  * public_id : UUID <<UNIQUE>>
  * subject : VARCHAR(255)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "conversation_participant" as conversation_participant {
  * conversation_id : BIGINT <<FK conversation.id>>
  * user_public_id : UUID   -- FK user.public_id
  * joined_at : TIMESTAMP
  * last_read_at : TIMESTAMP
  * PRIMARY_KEY(conversation_id, user_public_id)
}

entity "message" as message {
  * id : BIGINT <<PK>>
  * conversation_id : BIGINT <<FK conversation.id>>
  * sender_public_id : UUID   -- FK user.public_id
  * body : TEXT
  * attachments : VARCHAR(2000)   -- JSON or comma-separated URLs
  * read_at : TIMESTAMP
  * created_at : TIMESTAMP
}

entity "admin_action" as admin_action {
  * id : BIGINT <<PK>>
  * admin_public_id : UUID   -- FK to user.public_id (administrator)
  * action_type : VARCHAR(100)
  * target_entity : VARCHAR(100)
  * target_id : VARCHAR(255)
  * reason : TEXT
  * created_at : TIMESTAMP
}

entity "notification" as notification {
  * id : BIGINT <<PK>>
  * user_public_id : UUID   -- FK user.public_id
  * type : VARCHAR(100)
  * payload : TEXT
  * read : BOOLEAN
  * created_at : TIMESTAMP
}

entity "audit_log" as audit_log {
  * id : BIGINT <<PK>>
  * actor_public_id : UUID
  * action : VARCHAR(255)
  * target : VARCHAR(255)
  * details : TEXT
  * created_at : TIMESTAMP
}

' Relationships
user ||--o{ user_authority : has
authority ||--o{ user_authority : assigned_to

user ||--o{ listing : owns
listing ||--o{ listing_image : has

user ||--o{ booking : tenant_bookings
listing ||--o{ booking : bookings_for_listing
booking ||--o{ booking_addon : has_addons

user ||--o{ service : provides
service ||--o{ service_image : has_images
user ||--o{ service_booking : customer_service_bookings
service ||--o{ service_booking : service_bookings

booking }o--|| payment : payment_for_booking
service_booking }o--|| payment : payment_for_service_booking

user ||--o{ payment : payments_made
user ||--o{ payout : payouts_received

listing ||--o{ review : listing_reviews
service ||--o{ review : service_reviews
user ||--o{ review : written_reviews

conversation ||--o{ conversation_participant : has_participants
user ||--o{ conversation_participant : participates
conversation ||--o{ message : has_messages
user ||--o{ message : sends

user ||--o{ admin_action : performs
user ||--o{ notification : receives
user ||--o{ audit_log : performs

' FK notes (denormalized public_id usage)
note "FKs: many tables reference user.public_id (UUID) instead of user.id for external refs and safer public URLs." as N1

' Index / constraints notes
note top of listing_image
  PK = id
  FK listing_id -> listing.id
end note

note top of booking
  PK = id
  FK listing_id -> listing.id
  tenant_public_id -> user.public_id
end note

' end
@enduml
